language: rust
services: docker
sudo: required
cache: cargo

# This is required for coveralls
addons:
  apt:
    packages:
      - libcurl4-openssl-dev
      - libelf-dev
      - libdw-dev
      - binutils-dev
      - cmake
      
      # Actual sans dependencies
      - libv4l-dev
    sources:
      - kalakris-cmake

# This is a pretty big hack and only really needed on the first of a build chain
before_script:
  - (cargo install cargo-travis | true) && export PATH=$HOME/.cargo/bin:$PATH

# Build, test, benchmark, document. Gogogogo!
script:
  - cargo build --verbose --all
  - cargo test --verbose --all
  - cargo bench --all
  - cargo doc

matrix: # additional tests
  include:
  - rust: stable
  - rust: beta
  - rust: nightly
    script: |
      cargo test --all --features nightly
      cargo +nightly-2018-04-15 clippy --all -- -D warnings
  - rust: 1.25.0  # `stable`: Locking down for consistent behavior
    env: RUSTFMT=yes_please
    install:
    - rustup component add rustfmt-preview
    script:
    - cargo fmt --all -- --write-mode=diff

# Upload the whole mess
after_success:
  - cargo coveralls --verbose

# AND GOD DAMN IT LET ME SLEEP!
notifications:
  email:
    on_success: never
    on_failure: never
